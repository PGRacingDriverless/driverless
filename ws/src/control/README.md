# control

High-level task of vehicle control system is to calculate break, throttle and steering angle trajectories such that vehicle
follows reference trajectory generated by Path Planner. The general control system structure is depicted on figure below.

![Alt text](./control_system_project/images/driverless_control_system.png?raw=true "Control system")

# /minimal_working_example_no_ros
This directory aims to develop minimal working example of control system for [Formula Student Driverless Simulator](https://fs-driverless.github.io/Formula-Student-Driverless-Simulator/v2.2.0/).
After initial validation control system will be transformed to work with ROS.

This implementation is based on [Python client](https://fs-driverless.github.io/Formula-Student-Driverless-Simulator/v2.2.0/getting-started-with-python/). 
To install all required packages use:

```
pip install -r requirements.txt
```

To run FSDS follow [Installation](https://fs-driverless.github.io/Formula-Student-Driverless-Simulator/v2.2.0/getting-started/) instructions.

# Ros2 Bridge for Formula Student Driverless Simulator
This section describes how to configure ros2 bridge. This is used to connect autonomous system with Formula Student Driverless Simulator.
After configuration, topics generated by the simulator should be visible on the autonomous system.

**It is assumed that Formula Student Driverless simulator is running on host machine.**
### To enable required functionalities on ROS Humble (otherwise some packages won't build and ros2 command would not work)
```
source /opt/ros/humble/setup.bash
```
### Submodule fs_msgs for ROS2
Add fs_msgs as submodule (from repository workspace, on host machine)
```
`git submodule add https://github.com/PGRacingDriverless/fs_msgs.git`
```
To build fs_msgs interface on ROS2/Humble properly you need to switch to ros2 branch. (from repository workspace, on host machine)
```
git config -f .gitmodules submodule.fs_msgs.branch ros2
git submodule sync
git submodule update --init --remote
```
Build fs_msgs (from /ws dir, on ROS Humble)
``` 
colcon build --packages-select fs_msgs
source install/setup.bash 
```
### Build fsds_ros2_bridge
Build AirSim (from repository workspace, on ROS Humble)
```
sudo apt install rsync
cd Formula-Student-Driverless-Simulator/AirSim/
./setup.sh
./build.sh
```
Build FSDS Ros Bridge (from /ws dir, on ROS Humble)
```
colcon build --packages-select fsds_ros2_bridge
source install/setup.bash 
```
#### Configure workspace for fsds_ros2_brige.launch.py
```
mkdir /root/Formula-Student-Driverless-Simulator/
cp src/<repository_name>/Formula-Student-Driverless-Simulator/settings.json /root/Formula-Student-Driverless-Simulator/
mv /home/ros/ws/install/fsds_ros2_bridge/share/fsds_ros2_bridge/launch/fsds_ros2_bridge.launch.py /home/ros/ws/install/fsds_ros2_bridge/share/fsds_ros2_bridge/
```
#### Run fsds_ros2_bridge
```
ros2 launch fsds_ros2_bridge fsds_ros2_bridge.launch.py host:=<host address on docker0 interface>
```
You can check host address on docker interface by running 
```
ifconfig | grep -i docker -A 1
```
Listen to topics to validate ros bridge (from second docker terminal)
```
ros2 topic list
ros2 topic echo /gps
```
If ros2 command doesnt work run
```
source /opt/ros/humble/setup.bash
```

# LEGACY README SECTION
# Build Formula Student Driverless Simulator docker
### tried to configure <Docker autonomous system<->FSDS docker> connection, but fsds_ros2_bridge running on autonomous system doesnt connect to FSDS docker simulation (simulation crashes) -> Hot fix: Use FSDS installed on host machine. 
### TODO : Remove RoboticsII-FSDS fork from organization repository or fix connection problem
1. Clone repository with docker file.
```
git clone https://github.com/PGRacingDriverless/RoboticsII-FSDS.git
```
2. Build docker.
```
cd docker
docker build -t fsds --network=host -f Dockerfile .
```

3. Add docker access to nvidia (it's require sudo privileges to execute)

```
chmod +x xauth.sh
./xauth.sh
```

4. Run docker
```
./run_container.sh <container_id>
```
or 
```
docker run \
    -it --gpus all --privileged \
    --env="DISPLAY=$DISPLAY" \
    --env="QT_X11_NO_MITSHM=1" \
    --env="NVIDIA_DISABLE_REQUIRE=1" \
    --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
    --env="XAUTHORITY=$XAUTH" \
    --volume="$XAUTH:$XAUTH" \
    --env="NVIDIA_VISIBLE_DEVICES=all" \
    --env="NVIDIA_DRIVER_CAPABILITIES=all" \
    --network=host \
    --name=<container_id> \
    fsds
```

# Run FSDS
From FSDS docker run simulator
```
./FSDS.sh -- nosound headless
```
To enable bridge between FSDS and ROS you have to connect to container with new terminal
```
docker exec -it <container_id> bash
```
and then run command:
```
roslaunch fsds_ros_bridge fsds_ros_bridge.launch
```

You can also run rviz
```
roslaunch fsds_ros_bridge rviz.launch
```
and sensor plots
```
roslaunch fsds_ros_bridge plot.launch
```

# /control_system_ros
This directory will contain implementation of control system for ROS.

# /Literature

Directory contains .xlsx files for Systematic Literature Reviews on various topics.